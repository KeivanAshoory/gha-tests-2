name: Process Events

on:
  workflow_dispatch:

jobs:
  generate-events:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate events
        id: get-events
        run: |
          events=$(python3 scripts/prepare-all-events.py)
          echo ---------
          echo Events = $events
          echo ---------
          echo "events=$events" >> $GITHUB_OUTPUT
    outputs:
      events: ${{ steps.get-events.outputs.events }}

  process-events:
    needs: generate-events
    runs-on: ubuntu-latest
    strategy:
      matrix:
        event: ${{ fromJson(needs.generate-events.outputs.events) }}
      max-parallel: 4
    continue-on-error: true
    outputs:
      status: ${{ steps.check-status.outputs.status }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Process event
        id: check-status
        run: |
          echo "Processing event: ${{ toJson(matrix.event) }}"
          python3 scripts/process-one-event.py 'MY_ACTION' '${{ toJson(matrix.event) }}'
          if [ $? -ne 0 ]; then
            echo "script2.py failed for event: ${{ toJson(matrix.event) }}"
            echo "status=failure" >> $GITHUB_ENV
          else
            echo "script2.py succeeded for event: ${{ toJson(matrix.event) }}"
            echo "status=success" >> $GITHUB_ENV
          fi

      - name: Set job status
        id: set-job-status
        run: echo "::set-output name=status::${{ env.status }}"

  final-check:
    needs: process-events
    runs-on: ubuntu-latest
    steps:
      - name: Aggregate job statuses
        id: aggregate-statuses
        run: |
          failure_detected=false
          for status in ${{ needs.process-events.outputs.status }}; do
            if [[ "$status" == "failure" ]]; then
              failure_detected=true
              break
            fi
          done

          if [ "$failure_detected" == "true" ]; then
            echo "One or more events failed to process."
            exit 1
          else
            echo "All events processed successfully."
          fi